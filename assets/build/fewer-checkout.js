(()=>{"use strict";var t=function(t,e,i,o){return new(i||(i=Promise))((function(n,r){function d(t){try{c(o.next(t))}catch(t){r(t)}}function s(t){try{c(o.throw(t))}catch(t){r(t)}}function c(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(d,s)}c((o=o.apply(t,e||[])).next())}))};const e=t=>{if(t.disabled){t.disabled=!1;const e=new o(t);if(e.registerEventListeners(),"fewer-product-page"===e.position){const e=jQuery("form.variations_form");null==e||e.on("show_variation",(function(){t.disabled=!1})),null==e||e.on("hide_variation",(function(){t.disabled=!0}))}}};function i(){document.querySelectorAll("fewer-checkout-button").forEach(e)}document.addEventListener("DOMContentLoaded",(function(){i();const t=jQuery(document.body);t.on(FEWERWC_CONSTANTS.extraEvents,i),t.on("added_to_cart",(()=>{document.querySelectorAll(".fewer-product-page fewer-checkout-button").forEach((t=>{t.remove()}))}))})),window.onbeforeunload=function(){document.querySelectorAll("fewer-checkout-button").forEach((t=>{t.disabled=!0}))};class o{constructor(t){var e,i;this.handlingPrePayTrigger=!1,this.handlingCheckoutPayTrigger=!1,this.busyUpdatingOrder=!1,this.receivedSuccess=!1,this.originPrefix="",this.checkoutButton=t,this.buttonId=this.checkoutButton.getAttribute("ref-id"),this.position=this.checkoutButton.getAttribute("position"),this.orderContent=void 0,this.busyUpdatingOrder=!1,this.receivedSuccess=!1,this.backendURL=FEWERWC_CONSTANTS.transactionDetailsURL,this.pre_existing_order_id=null!==(i=null===(e=this.checkoutButton)||void 0===e?void 0:e.getAttribute("checkout-order-id"))&&void 0!==i?i:void 0,this.buttonVersion=FEWERWC_CONSTANTS.pluginVersion,this.originPrefix=""}registerEventListeners(){this.checkoutButton.getAttribute("events-registered")||(this.checkoutButton.addEventListener("fewerCheckoutSuccess",(t=>{if(this.receivedSuccess=!0,!this.busyUpdatingOrder)try{t.detail.orderId&&this.genOrderId&&(window.location.href=window.location.origin+this.originPrefix+"?fewer_order_created="+this.genOrderId)}catch(t){throw new Error(null==t?void 0:t.toString())}}),!1),this.checkoutButton.addEventListener("updateOrderOnPaymentsuccess",(t=>{this.busyUpdatingOrder=!0,t.detail.orderId&&this.completeOrder().then((()=>{this.busyUpdatingOrder=!1,this.receivedSuccess&&this.genOrderId&&(window.location.href=window.location.origin+this.originPrefix+"?fewer_order_created="+this.genOrderId)})).catch((t=>{throw new Error(null==t?void 0:t.toString())}))}),!1),this.checkoutButton.addEventListener("fewerAddressUpdate",(e=>{const i=window.location.origin+this.originPrefix+"/wp-json/wc/fewer/v2/checkout/update";n(i,{fewer_cart_id:this.buttonId,address_details:e.detail}).then((e=>t(this,void 0,void 0,(function*(){return yield e.json()})))).then((t=>{this.checkoutButton.setAttribute("discount",t.discount),this.checkoutButton.setAttribute("taxes",t.taxes),this.checkoutButton.setAttribute("amount",t.amount),this.checkoutButton.setAttribute("shipping-methods",JSON.stringify(t.shipping_methods)),this.checkoutButton.shippingMethods=t.shipping_methods,this.checkoutButton.dispatchEvent(new Event("fewerAddressAck"))})).catch((t=>{console.log(t)}))}),!1),this.checkoutButton.addEventListener("fewerDismissed",(t=>{t.detail.orderId&&(this.genOrderId&&this.completeOrder(t.detail.paymentSuccessful).catch((t=>{console.log(t)})),this.checkoutButton.disabled=!0,this.cancelOrder(t.detail.orderId).finally((()=>{this.checkoutButton.disabled=!1,this.genOrderId=void 0})))}),!1),this.checkoutButton.addEventListener("fewerPrePayTrigger",(e=>{if(this.handlingPrePayTrigger)return;this.handlingPrePayTrigger=!0;const i=window.location.origin+this.originPrefix+"/wp-json/wc/fewer/v2/order/create";n(i,{fewer_cart_id:this.buttonId,transaction_details:e.detail,fewer_order_id:this.pre_existing_order_id}).then((e=>t(this,void 0,void 0,(function*(){const t=yield e.json();if(!e.ok)throw new Error(t);return t})))).then((t=>{this.genOrderId=t.order_id,this.checkoutButton.setAttribute("amount",t.amount),this.checkoutButton.dispatchEvent(new CustomEvent("fewerPrePayTriggerAck",{detail:{order_total_amount:t.amount,order_id:t.order_id}}))})).catch((t=>{this.checkoutButton.dispatchEvent(new CustomEvent("fewerPrePayTriggerError",{detail:{description:null==t?void 0:t.toString()}}))})).finally((()=>{this.handlingPrePayTrigger=!1}))}),!1),this.checkoutButton.addEventListener("fewerPreCheckoutTrigger",(e=>{this.handlingCheckoutPayTrigger||(this.handlingCheckoutPayTrigger=!0,("fewer-product-page"===this.position?r().then((()=>t(this,void 0,void 0,(function*(){yield this.createCheckout()})))):this.createCheckout()).then((()=>{var t;const e=null===(t=this.checkoutButton)||void 0===t?void 0:t.getAttribute("amount");if(!(this.orderContent&&this.checkoutButton&&e&&parseFloat(e)>0))throw new Error("Cannot Proceed With Amount Of Zero");this.checkoutButton.dispatchEvent(new CustomEvent("fewerPreCheckoutTriggerAck",{detail:{order_position:this.position,order_content:JSON.stringify(this.orderContent),plugin_version:this.buttonVersion?"woocommerce "+this.buttonVersion:void 0}}))})).catch((t=>{this.checkoutButton.dispatchEvent(new CustomEvent("fewerPreCheckoutTriggerError",{detail:{description:null==t?void 0:t.toString()}}))})).finally((()=>{this.handlingCheckoutPayTrigger=!1})))}),!1),this.checkoutButton.setAttribute("events-registered","true"))}createCheckout(){return t(this,void 0,void 0,(function*(){const t=window.location.origin+this.originPrefix+"/wp-json/wc/fewer/v2/checkout/create",e=yield n(t,{fewer_cart_id:this.buttonId,pre_existing_order_id:this.pre_existing_order_id}),i=yield e.json();this.checkoutButton.setAttribute("taxes",i.taxes),this.checkoutButton.setAttribute("amount",i.amount),this.checkoutButton.setAttribute("discount",i.discount),this.orderContent=i.order_content}))}cancelOrder(e){return t(this,void 0,void 0,(function*(){if("fewer-product-page"===this.position){const t=window.location.origin+this.originPrefix+"/wp-json/wc/fewer/v2/orders/cancel";return yield n(t,{fewer_cart_id:this.buttonId,fewer_transaction_id:e})}}))}completeOrder(e=!0){var i,o,r;return t(this,void 0,void 0,(function*(){const t=null!==(r=null!==(o=null===(i=this.checkoutButton)||void 0===i?void 0:i.getAttribute("checkout-order-id"))&&void 0!==o?o:this.genOrderId)&&void 0!==r?r:"",d=window.location.origin+this.originPrefix+"/wp-json/wc/fewer/v2/order/complete";return yield n(d,{fewer_cart_id:this.buttonId,order_id:t,assert_transaction_status:e})}))}}const n=function(e,i){return t(this,void 0,void 0,(function*(){return yield fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)})}))},r=()=>t(void 0,void 0,void 0,(function*(){var t;const e=document.querySelector("form.cart");if(null==e)throw new Error("Product form not found");const i=null!==(t=e.getAttribute("action"))&&void 0!==t?t:window.location.href;if(!i)throw new Error("Product form URL not found");const o=document.querySelector("form.cart button[type='submit']");if(!o)throw new Error("Submit button not found");const n=o.value,r=new FormData(e),s=Object.assign({"add-to-cart":n},Object.fromEntries(r.entries()));yield d(i,s)})),d=(e,i)=>t(void 0,void 0,void 0,(function*(){yield new Promise(((t,o)=>{jQuery.ajax({url:e,type:"POST",data:i,success:function(e){if((null==e?void 0:e.indexOf("woocommerce-error"))>0){const t=(new DOMParser).parseFromString(e,"text/html").querySelectorAll(".woocommerce-error li"),i=[];if(t.forEach((t=>{var e,o;i.push(null!==(o=null===(e=t.textContent)||void 0===e?void 0:e.trim())&&void 0!==o?o:"")})),i.length>0)return void o(new Error(i.join("\n")))}t()},error:function(){o(new Error("ajax adding to cart error"))}})}))}))})();